<!doctype html>

<html lang="en">
<head>
  <link rel="stylesheet" href="styles.css">
  <script src="//unpkg.com/3d-force-graph"></script>
  <!-- <script src="/node_modules/3d-force-graph/dist/3d-force-graph.js"></script> -->
  <!-- <script src="/node_modules/three/build/three.js"></script> -->
  <!-- <script src="/node_modules/JQuery/lib/node-jquery.js"></script> -->

  <!-- <script src="//unpkg.com/three-spritetext"></script> -->
  <script src=//threejs.org/build/three.js></script>

  <title>ESP</title>

</head>
<body>

  <div class="parent">
   <header class="pink section">
     <button id="btn_loadnet" onclick="getnet()">Load network</button>
     <button id="btn_loadart" onclick="getart()">Load artificial</button>
     Number of nodes:
     <input type="number" id="nodes" name="nnodes" min="10" max="60">
     Number of edges:
     <input type="number" id="edges" name="nedges" min="20" max="120">

     <button id="btn_reset">Reset view</button>
   </header>
   <div class="left-side blue section" contenteditable>Left Sidebar</div>
   <div class="maincontain">
     <main id="3d-graph" class="section coral" contenteditable>
       <!-- <div >
         < <div style="position: absolute;"> -->
       <!-- The text to be added, will be written here! :) -->
       <!-- </div> --> -->
     </main>
   </div>
   <div class="right-side yellow section" contenteditable>Right Sidebar</div>
   <footer class="green section">Footer</footer>
 </div>


  <script>



    function getnet(params = "") {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("recieved network!");
          var graphdata = JSON.parse(JSON.parse(this.responseText));
          // console.log(graphdata.nodes)
          const selectedNodes = new Set();
           // const highlightLinks = new Set();
          let hoverNode = null;
          const graph = ForceGraph3D() // should be const
            (document.getElementById('3d-graph'))
              // .nodeColor(node => 'rgb(255,0,111,1)')
              // pink = 'rgb(255,0,255,0.7)'
              // orange = 'rgba(219,131,16,0.7)'
              // blue = 'rgb(0,0,170,0.7)'
              // red = 'rgb(255,51,51,0.7)'
              // left selected and right normal
              .nodeColor(node =>selectedNodes.has(node) ? 'rgb(255,10,10,0.8)': 'rgb(0,0,170,0.7)')
              // .nodeOpacity(1)
              .nodeLabel(d => `<span style="font-size: 170%; color: #01653A; font-weight: bold;">${d.id}</span>`)
              // .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
              // .nodeThreeObject(node => {
              //   const sprite = new SpriteText(node.id);
              //   sprite.material.depthWrite = false; // make sprite background transparent
              //   sprite.color = node.color;
              //   sprite.textHeight = 8;
              //   return sprite;
              // })
              .enableNodeDrag(false)
              // purple 'rgba(124,21,65,1)'
              .linkColor(link => 'rgba(30,30,30,0.3)')
              // link width is very slow
              // .linkWidth(0.5)
              .linkOpacity(1)
              // .width(1200)
              // .height(800)
              .onNodeClick((node, event) => {
                  if (event.ctrlKey || event.shiftKey || event.altKey) { // multi-selection
                    selectedNodes.has(node) ? selectedNodes.delete(node) : selectedNodes.add(node);
                  } else { // single-selection
                    const untoggle = selectedNodes.has(node) && selectedNodes.size === 1;
                    selectedNodes.clear();
                    !untoggle && selectedNodes.add(node);
                  }
                  graph.nodeColor(graph.nodeColor()); // update color of selected nodes
              })
              .graphData(graphdata);
          graph.renderer().setClearColor( 0x000000, 0 );
          graph.backgroundColor('#FFFFFF');

          // console.log(graph.renderer().domElement);
          graph.renderer().domElement.style = "grid-column: 2 / 3";
          graph.renderer().domElement.removeAttribute("width");
          graph.renderer().domElement.removeAttribute("height");

          // console.log(graph.renderer().domElement);


          function updateHighlight() {
            // trigger update of highlighted objects in scene
            graph
              .nodeColor(graph.nodeColor())
              // .linkWidth(Graph.linkWidth())
              // .linkDirectionalParticles(Graph.linkDirectionalParticles());
          }
          function resetView() {
            graph.zoomToFit(400)
            // graph.onEngineStop(() => );
          }
          var button = document.getElementById("btn_reset");
          button.onclick = function(){resetView()};

          var element = document.getElementById('3d-graph')
          // console.log(getComputedStyle(element));
          element.style.flexBasis = "inherit";
          element.style.gridColumn = "2 / 3";
          element.style.placeItems = "center";
          element.style.height = "inherit";
          element.style.width = "inherit";
          graph.renderer().domElement.style.height = "inherit";
          graph.renderer().domElement.style.width = "inherit";
          graph.renderer().domElement.style.placeItems = "center";
          graph.renderer().domElement.style.flexBasis = "inherit";
          // element.style.removeProperty('blockSize');
          // element.style.removeProperty('height');
          // element.style.removeProperty('width');
          // element.style.removeProperty('inlineSize');
          // element.style.removeProperty('perspectiveOrigin');
          // element.style.removeProperty('transformOrigin');
          // element.style.removeProperty('webkitLogicalHeight');
          // element.style.removeProperty('webkitPerspectiveOrigin');
          // element.style.removeProperty('webkitLogicalWidth');
          // console.log(getComputedStyle(element));
        }
      };
      var url = "http://127.0.0.1:5000" + params
      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
      xhttp.send();
    }
    // var net = getnet();

    function getart(){

      nodes = document.getElementById("nodes").value;
      edges = document.getElementById("edges").value;
      console.log(nodes);
      console.log(edges);
      let extraparam = ""
      if (nodes !== null) {
        extraparam = extraparam + "&nodes=" + nodes.toString()
      }
      if (edges !== null) {
        extraparam = extraparam + "&edges=" + edges.toString()
      }
      getnet('?artificial=True'+ extraparam);
    }


    // TODO on reset button: Graph.zoomToFit(400))

    // import * as THREE from '/node_modules/three/build/three.js';
    // var ForceGraph3D = require('3d-force-graph');
    // Random tree
    // const GROUPS = 12;
    // const N = 300;
    // const gData = {
    //   nodes: [...Array(N).keys()].map(i => ({ id: i, group:  Math.ceil(Math.random() * GROUPS)})),
    //   links: [...Array(N).keys()]
    //     .filter(id => id)
    //     .map(id => ({
    //       source: id,
    //       target: Math.round(Math.random() * (id-1))
    //     }))
    // };
    // var renderer = new THREE.WebGLRenderer( { alpha: true } );
    // renderer.setClearColor( 0x000000, 0 );

    // const graph = ForceGraph3D()
    //   (document.getElementById('3d-graph'))
    //     .nodeAutoColorBy('group')
    //     .nodeOpacity(1)
    //     .enableNodeDrag(false)
    //     .linkColor('#00FF00')
    //     // link width is very slow
    //     // .linkWidth(0.5)
    //     .linkOpacity(1)
    //     .graphData(graphdata);
    // graph.renderer().dispose();
    // graph.renderer() = new THREE.WebGLRenderer( { alpha: true } );
    // graph.renderer().setClearColor( 0x000000, 0 );
    // // graph.renderer().clearColor();
    // // graph.renderer().state.reset();
    // // graph.renderer().setClearAlpha(1);
    // // graph.renderer().clear(true, true, true);
    // console.log(graph.backgroundColor());
    // graph.backgroundColor('#FFFFFF');
    // console.log(graph.backgroundColor());
    // console.log(graph.scene());

    // TODO add brain loadModel
    //https://github.com/mrdoob/three.js/blob/master/examples/webgl_loader_obj.html
    //https://mollermara.com/blog/brain-in-threejs/
    //https://mollermara.com/static/threejs-brain/object-stuff.js
    // import { OBJLoader } from 'three';
    // let object;
    // function loadModel() {
  	// 	object.traverse( function ( child ) {
    //
  	// 		if ( child.isMesh ) child.material.map = texture;
    //
  	// 	} );
    //
  	// 	object.position.y = - 95;
  	// 	graph.scene().add( object );
    // }
    //
    // const manager = new THREE.LoadingManager( loadModel );
    // const loader = new OBJLoader( manager );
		// loader.load( 'freesurf.OBJ', function ( obj ) {
    //
		// 	object = obj;
    //
		// }, onProgress, onError );
    //

    // graph.scene().background = new THREE.Color( 0x000000 );
  </script>
</body>
</html>
