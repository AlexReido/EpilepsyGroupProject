<!doctype html>

<html lang="en">
<head>
  <link rel="stylesheet" href="search.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.1.1/dist/chart.min.js"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <!-- <script src="/node_modules/3d-force-graph/dist/3d-force-graph.js"></script> -->
  <!-- <script src="/node_modules/three/build/three.js"></script> -->
  <!-- <script src="/node_modules/JQuery/lib/node-jquery.js"></script> -->

  <!-- <script src="//unpkg.com/three-spritetext"></script> -->
  <!-- <script src=//threejs.org/build/three.js></script> -->

  <title>ESP</title>
</head>
<body>

  <div class="parent">
   <header class="pink section">
     <a href="home.html">
       <button class="btn" id="btn_home"><i class="fa fa-home"></i></button>
    </a>
    <a id="generate-link" href="generate.html">
      <button class="btn" id="btn_generate">Generate Network</button>
    </a>
     <button class="btn" id="btn_reset">Reset view</button>

     <button  class="btn" id="btn_search" onclick="searchNet()">Search Network</button>
     <div class="dropdown">
      <button class="dropbtn" onclick="settingsDropdown()"><i class="fa fa-cog"></i></button>
      <div id="settingsDropdown" class="dropdown-content">

        <div class="dropped">
          <label for="fname">Filename:</label>
          <input type="text" id="fname" name="fname">
        </div>
        <!-- <br> -->
        <div class="dropped">
          Number of generations:
          <input type="number" id="generations" name="ngens" min="5" max="200">
        </div>
        <!-- <br> -->
        <div class="dropped">
          Maximum number of nodes:
          <br>
          <input type="number" id="nodes" name="nnodes" min="2" max="120">
        </div>
        <button class="dropped" id="customSearchbtn" onclick="customSearch()">Search</button>
     </div>
     </div>
     <button class="btn" id="btn_saveNet" onclick="saveNet()">Save network</button>
     <!-- <button class="btn" id="btn_getPlot" onclick="get_results_plot()">Get plot</button> -->

    <!-- <button class="btn" id="btn_get_search" onclick="get_searches()">Get search status</button> -->
     <!-- <input type="file" data-buttonText="Open network file"/> -->
     <hr style="">
   </header>

   <div id="left" class="left-side blue section" contenteditable>
     <div>
       Currently running searches:
       <div id="running_searches" style="margin-top:10px;">
      </div>

    </div>
    <br>
      <button id="btn_refresh_searches" onclick="get_searches()">Refresh searches</button>
     <br>
     <hr>
     <div id="selectedNodes">
     </div>

   </div>

   <div class="maincontain">
     <main id="3d-graph" class="section coral" contenteditable>

     </main>
   </div>
   <div id="right" class="right-side yellow section" contenteditable>
     <table id="results-table">
        <thead>
            <tr>
              <th colspan="2" id="tabel header">Results of generation </th>
            </tr>
            <tr>
                <th>The number of nodes resected:</th>
                <th>The BNI:</th>
            </tr>
        </thead>
        <tbody id="table body">

        </tbody>
    </table>
    <div id="paretoplotDiv">
      <canvas id="myChart"></canvas>
    </div>
   </div>
   <footer class="green section">

   </footer>
 </div>


  <script>

    console.log(window.innerWidth);
    console.log(window.innerHeight);

    var graph;
    var selectedNodes;
    var adjacency_matrix =localStorage.getItem("net");
    var globalresults = null;
    var myChart = null;
    var selectedDiv = "";
    // var x = document.getElementsByClassName('optionsecoptions')
    // for (var i = 0; i < x.length; i++) {
    //     x[i].addEventListener("click", function(){
    //
    //     var selectedEl = document.querySelector(".selected");
    //     pollServer(selectedEl.innerText);
    //     if(selectedEl){
    //         selectedEl.classList.remove("selected");
    //     }
    //
    //     this.classList.add("selected");
    //
    //     get_results_plot();
    //     }, false);
    // }

    // document.getElementById('btn_get_search').addEventListener('click',function(){
    //   var selectedEl = document.querySelector(".selected");
    //   if(selectedEl)
    //       pollServer(selectedEl.innerText);
    //   else
    //       alert('please choose an option');
    // })


    // console.log(adjacency_matrix);
    if (adjacency_matrix != null){
      var graphJson =  getGraphData(adjacency_matrix, 0.008, false);
      // console.log(graphJson);
      displaygraph(graphJson);
      // console.log(graphJson);
    }

    // ==================Plotting chart ===============


    function get_results_plot(){
      if (myChart != null){
        myChart.destroy()
      }
      datalist=[]
      for (var n of globalresults){
        datalist.push({x: n[0], y: n[1]})
      }

      var plotdata = {
        datasets: [{
          // label: 'Scatter Dataset',
          data: datalist,
          backgroundColor: 'rgb(255, 99, 132)'
        }],
      };

      var config = {
        type: 'scatter',
        data: plotdata,
        options: {
          plugins: {
            legend: {
                display: false
            },
            title: {
                display: true,
                text: 'Pareto front'
            }
          },
          scales: {
            xAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'BNI'
              },
              // type: 'linear',
              position: 'bottom'
            }],
            yAxes: [{
              // type: 'linear',
              // position: 'bottom'
            }]
          }

        }
      };

      myChart = new Chart(
        document.getElementById('myChart'),
        config
      );

      // filename = document.getElementById("fname").value;
      // var xhttp = new XMLHttpRequest();
      // xhttp.onreadystatechange = function() {
      //   if (this.readyState == 4 && this.status == 200) {
      //     console.log("recieved results!");
      //     console.log(JSON.parse(this.responseText));
      //
      //   }
      // };
      // var url = "http://127.0.0.1:5000/plot/";
      // xhttp.open("POST", url, true);
      // xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
      // data = {"filename":filename,
      //         "results": globalresults,
      //       };
      // xhttp.send(JSON.stringify(data));
    }

    // ------------------Search settings ----------------------
    function settingsDropdown() {
      document.getElementById("settingsDropdown").classList.toggle("show");
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function(event) {
      if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }

    function customSearch(){
      nodes = document.getElementById("nodes").value;
      generations = document.getElementById("generations").value;
      filename = document.getElementById("fname").value;
      date = new Date().toLocaleString('en-GB', { timeZone: 'Europe/London' });
      date = date.split(", ")[1] +", " + date.split(", ")[0];
      data = {"filename":(filename+" " + date),
              "adj_mat": adjacency_matrix,
              "node_list": [],
              "n_gens": generations,
              "max_nodes": nodes
            };
      searchNet(data)
    }

    // ========== Get all searches being run on server ==========================
    function get_searches(){
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("recieved search list");
          // console.log(JSON.parse(this.responseText));
          res = JSON.parse(JSON.parse(this.responseText));
          // console.log(this.responseText);
          console.log(JSON.parse(JSON.parse(this.responseText)));
          var running_searches = "";
          res.forEach((val, i) => {
            var div = "<div class='optionsecoptions'>" + val + "</div>";
            running_searches = running_searches + div;
          });
          console.log(running_searches);
          document.getElementById("running_searches").innerHTML = running_searches;
          var x = document.getElementsByClassName('optionsecoptions')
          for (var i = 0; i < x.length; i++) {
              x[i].addEventListener("click", function(){

              var selectedEl = document.querySelector(".selected");

              if(selectedEl){
                  selectedEl.classList.remove("selected");
              }

              this.classList.add("selected");
              var selEl = document.querySelector(".selected");
              pollServer(selEl.innerText);
              // console.log(selEl);
              // console.log(selEl.innerText);
              // await sleep(1000);

              }, false);
          }

        }
      };
      var url = "http://127.0.0.1:5000/search/all";
      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
      xhttp.send();
    }


// ================== Results Table =====================================
    function highlight(e) {
      if (selected[0]) selected[0].className = '';
      e.target.parentNode.className = 'selected_res';
      var s = e.target.parentNode.getAttribute("data-nodelist")
      console.log(s);

      var array = JSON.parse("[" + s + "]");
      console.log(array)
      updateSelectedList(array, raw=true);
      // var nlist = [];
      selectedNodes.clear();
      for (var n of array){
        selectedNodes.add(graph.graphData().nodes[n]);
      }

      console.log(selectedNodes)
      graph.nodeColor(graph.nodeColor());
    }

    var table = document.getElementById('results-table'),
    selected = table.getElementsByClassName('selected_res');
    table.onclick = highlight;


    function updateResults(results){
      var res_list = "";
      //  = <tr>
      //     <td>The table body</td>
      //     <td>with two columns</td>
      // </tr>;
      // results = JSON.parse(results);
      // console.log(results);
      gen_num = Object.keys(results)[0];
      table_header = document.getElementById("tabel header");
      table_header.innerHTML = "Results of generation: " + String(gen_num)

      // res_list = res_list + String(gen_num) + ":<br />"
      results = results[gen_num];
      globalresults = results;
      console.log(results);
      for (var n of results){
        console.log(n);
        let val = "<tr data-nodelist=\"" + n[2] + "\"> <td> " + n[0] + "</td><td>"+ Math.round(n[1] * 10000) / 10000 + "</td> </tr>"; //+ "<br />"
        console.log(val)
        res_list = res_list + val;
      }
      document.getElementById("table body").innerHTML = res_list;
      get_results_plot();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function pollServer(filename){
      finished = false;
      while (finished == false){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log("recieved results!");
            // console.log(JSON.parse(this.responseText));
            res = JSON.parse(JSON.parse(this.responseText));
            console.log(res.results);
            finished = res.finished;
            console.log(res.finished);
            if (res.results != {}){
              updateResults(res.results);
            }
            // console.log(graphdata.nodes
          }
        };
        var url = "http://127.0.0.1:5000/search/?filename=" + filename;
        xhttp.open("GET", url, true);
        xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
        xhttp.send();
        await sleep(5000);
      }
    }

    async function searchNet(data=null){
      var url = "http://127.0.0.1:5000/search/"
      var xhttp = new XMLHttpRequest();
      date = new Date().toLocaleString('en-GB', { timeZone: 'Europe/London' });
      // Time first
      filename = date.split(", ")[1] +", " + date.split(", ")[0];
      // xhttp.onreadystatechange = function() {
      //   if (this.readyState == 4 && this.status == 200) {
      //     console.log("recieved results!!");
      //     console.log(this.responseText);
      //
      //     // var graphdata = getGraphData(this.responseText, 0.008);
      //     // console.log("json==", graphdata);
      //     // // console.log(graphdata.nodes)
      //     // displaygraph(graphdata);
      //   }
      // };
      xhttp.open("POST", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin",'application/json; charset=UTF-8');
      // console.log(JSON.stringify({"matfile":data}));
      if (data == null){
        data = {"filename":filename,
                "adj_mat": adjacency_matrix,
                "node_list": [],
                "n_gens": 30,
                "max_nodes": 20
              };
      }
      xhttp.send(JSON.stringify(data));
      await sleep(4000)
      pollServer(data.filename)
    }

    // TODO openresullts file in another page?

    // const fileopen = document.querySelector('input[type="file"]')
    // fileopen.addEventListener('change', function(e){
    //   // console.log(fileopen.files);
    //   const reader = new FileReader();
    //   reader.onload = function(){
    //     adjacency_matrix = reader.result;
    //     console.log("read in= ", adjacency_matrix);
    //     var graphJson =  getGraphData(adjacency_matrix, 0.008, false);
    //     // console.log(graphJson);
    //     displaygraph(graphJson);
    //   }
    //   reader.readAsText(fileopen.files[0])
    // }, false);

    function updateSelectedList(selectedNodes, raw=false){
      var node_list = "Selected nodes: <br />";
      if (raw == false) {
        for (var n of selectedNodes.values()){
          console.log(String(n.id));
          let val = String(n.id)+ "<br />"; //+ "<br />"
          node_list = node_list + val;
        }
      } else{
        for (var n of selectedNodes){
          console.log(String(n));
          let val = String(n)+ "<br />"; //+ "<br />"
          node_list = node_list + val;
        }
      }

      document.getElementById("selectedNodes").innerHTML = node_list;
    }

    function saveNet(){
      // TODO if null
      let data = JSON.stringify(adjacency_matrix);
      // fs.writeFileSync('net.json', data);
      function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }
      console.log(data);
      download(data, 'json.txt', 'text/plain');
      // var csvfile = new Blob(data);
      // console.log(csvfile);
      // downloadBlob(csvfile, 'network.json');

    }

    function getGraphData(adjacency, linkthreshold, json = true){
      // console.log(adjacency)
      if (json ==  true){
        var adj = JSON.parse(JSON.parse(adjacency));
      }else{
        var adj =JSON.parse(adjacency);
      }
      // console.log(adj)
      adjacency_matrix = adj;

      // console.log(adj);
      // console.log(typeof adj);
      // const adjacency = adjacency
      nodes = [];
      edges = [];
      adj.forEach(function (row, i) {
        // console.log(i)
        nodes.push({"id": i});
        row.forEach(function (link, j) {
          // console.log(i, j)
          if (link > linkthreshold){
            edges.push({
              "source": i,
              "target" : j,
              "val" : link,
            });
          }
        });
        i ++;
      });
      // console.log(nodes);
      // console.log(edges);
      return {"nodes": nodes, "links": edges};
    }

    function getnet(params = "") {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("recieved network!");
          var graphdata = GraphData(this.responseText, 0.008);
          console.log("json==", graphdata);
          // console.log(graphdata.nodes)
          displaygraph(graphdata);
        }
      };
      var url = "http://127.0.0.1:5000" + params
      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
      xhttp.send();
    }

    // var net = getnet();
    function displaygraph(graphData){
      selectedNodes = new Set();
      updateSelectedList(selectedNodes);
       // const highlightLinks = new Set();
      let hoverNode = null;
      var graphElem = document.getElementById('3d-graph');
      var graphHeight = graphElem.getBoundingClientRect().height;
      var graphWidth = graphElem.getBoundingClientRect().width;
      console.log(graphHeight)
      graph = ForceGraph3D() // should be const
        (graphElem)
          // .nodeColor(node => 'rgb(255,0,111,1)')
          // pink = 'rgb(255,0,255,0.7)'
          // orange = 'rgba(219,131,16,0.7)'
          // blue = 'rgb(0,0,170,0.7)'
          // red = 'rgb(255,51,51,0.7)'
          // left selected and right normal
          .height(String(window.innerHeight-130)) //600
          .width(String(window.innerWidth-500))  //900
          .nodeColor(node =>selectedNodes.has(node) ? 'rgb(255,10,10,0.8)': 'rgb(0,0,170,0.7)')
          // .nodeOpacity(1)
          .nodeLabel(d => `<span style="font-size: 170%; color: #01653A; font-weight: bold;">${d.id}</span>`)
          // .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
          // .nodeThreeObject(node => {
          //   const sprite = new SpriteText(node.id);
          //   sprite.material.depthWrite = false; // make sprite background transparent
          //   sprite.color = node.color;
          //   sprite.textHeight = 8;
          //   return sprite;
          // })
          .enableNodeDrag(false)
          // purple 'rgba(124,21,65,1)'
          .linkColor(link => 'rgba(30,30,30,0.3)')
          // link width is very slow
          // .linkWidth(0.5)
          .linkOpacity(1)
          // .width(1200)
          // .height(800)
          .onNodeClick((node, event) => {
              if (event.ctrlKey || event.shiftKey || event.altKey) { // multi-selection
                selectedNodes.has(node) ? selectedNodes.delete(node) : selectedNodes.add(node);
              } else { // single-selection
                const untoggle = selectedNodes.has(node) && selectedNodes.size === 1;
                selectedNodes.clear();
                !untoggle && selectedNodes.add(node);
              }
              graph.nodeColor(graph.nodeColor()); // update color of selected nodes
              updateSelectedList(selectedNodes);
          })
          .graphData(graphData);
      graph.renderer().setClearColor( 0x000000, 0 );
      graph.backgroundColor('#FFFFFF');

      function updateHighlight() {
        // trigger update of highlighted objects in scene
        graph
          .nodeColor(graph.nodeColor())
          // .linkWidth(Graph.linkWidth())
          // .linkDirectionalParticles(Graph.linkDirectionalParticles());
      }
      function resetView() {
        graph.zoomToFit(400)
        // graph.onEngineStop(() => );
      }
      var button = document.getElementById("btn_reset");
      button.onclick = function(){resetView()};

      var element = document.getElementById('3d-graph')

    }

  </script>
</body>
</html>
