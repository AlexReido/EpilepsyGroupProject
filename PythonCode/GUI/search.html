<!doctype html>

<html lang="en">
<head>
  <link rel="stylesheet" href="generate.css">
  <script src="//unpkg.com/3d-force-graph"></script>
  <!-- <script src="/node_modules/3d-force-graph/dist/3d-force-graph.js"></script> -->
  <!-- <script src="/node_modules/three/build/three.js"></script> -->
  <!-- <script src="/node_modules/JQuery/lib/node-jquery.js"></script> -->

  <!-- <script src="//unpkg.com/three-spritetext"></script> -->
  <!-- <script src=//threejs.org/build/three.js></script> -->

  <title>ESP</title>
</head>
<body>

  <div class="parent">
   <header class="pink section">

     <button id="btn_reset">Reset view</button>
     <label for="fname">Filename:</label>
     <input type="text" id="fname" name="fname">
     <button id="btn_search" onclick="searchNet()">Search Network</button>
     <button id="btn_saveNet" onclick="saveNet()">Save network</button>
     <!-- <input type="file" data-buttonText="Open network file"/> -->
     <div>
       Currently running searches:
        <!-- <option selected disabled>Choose here</option>
        <option value="1">One</option>
        <option value="2">Two</option>
        <option value="3">Three</option>
        <option value="4">Four</option>
        <option value="5">Five</option> -->
    </div>
   </header>
   <div id="left" class="left-side blue section" contenteditable></div>
   <div class="maincontain">
     <main id="3d-graph" class="section coral" contenteditable>

     </main>
   </div>
   <div id="right" class="right-side yellow section" contenteditable>
     <table>
        <thead>
            <tr>
              <th>Results of generation </th>
            </tr>
            <tr>
                <th>The number of nodes resected:</th>
                <th>The BNI:</th>
            </tr>
        </thead>
        <tbody id="table body">

        </tbody>
    </table>
   </div>
   <footer class="green section">
     <a href="home.html">
       <button id="btn_home">Home page</button>
    </a>
   </footer>
 </div>


  <script>
    var adjacency_matrix =localStorage.getItem("net");
    console.log(adjacency_matrix);
    if (adjacency_matrix != null){
      var graphJson =  getGraphData(adjacency_matrix, 0.008, false);
      // console.log(graphJson);
      displaygraph(graphJson);
    }

    function updateResults(results){
      var res_list = "";
      //  = <tr>
      //     <td>The table body</td>
      //     <td>with two columns</td>
      // </tr>;
      // results = JSON.parse(results);
      // console.log(results);
      gen_num = Object.keys(results)[0];
      res_list = res_list + String(gen_num) + ":<br />"
      results = results[gen_num];
      console.log(results);
      for (var n of results){
        console.log(n);
        let val = "<tr> <td> " + n[0] + "</td><td>"+ n[1] + "</td> </tr>"; //+ "<br />"
        console.log(val)
        res_list = res_list + val;
      }
      document.getElementById("table body").innerHTML = res_list;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function pollServer(filename){
      finished = false;
      while (finished == false){
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log("recieved results!");
            // console.log(JSON.parse(this.responseText));
            res = JSON.parse(JSON.parse(this.responseText));
            console.log(res.results);
            finished = res.finished;
            console.log(res.finished);
            if (res.results != {}){
              updateResults(res.results);
            }
            // console.log(graphdata.nodes
          }
        };
        var url = "http://127.0.0.1:5000/search/?filename=" + filename;
        xhttp.open("GET", url, true);
        xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
        xhttp.send();
        await sleep(5000);
      }
    }

    async function searchNet(){
      var url = "http://127.0.0.1:5000/search"
      var xhttp = new XMLHttpRequest();
      filename = document.getElementById("fname").value;
      // xhttp.onreadystatechange = function() {
      //   if (this.readyState == 4 && this.status == 200) {
      //     console.log("recieved results!!");
      //     console.log(this.responseText);
      //
      //     // var graphdata = getGraphData(this.responseText, 0.008);
      //     // console.log("json==", graphdata);
      //     // // console.log(graphdata.nodes)
      //     // displaygraph(graphdata);
      //   }
      // };
      xhttp.open("POST", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin",'application/json; charset=UTF-8');
      // console.log(JSON.stringify({"matfile":data}));

      data = {"filename":filename,
              "adj_mat": adjacency_matrix,
              "node_list": [],
              "n_gens": 30,
              "max_nodes": 20
            };
      xhttp.send(JSON.stringify(data));
      await sleep(4000)
      pollServer(filename)
    }

    // TODO openresullts file in another page?

    // const fileopen = document.querySelector('input[type="file"]')
    // fileopen.addEventListener('change', function(e){
    //   // console.log(fileopen.files);
    //   const reader = new FileReader();
    //   reader.onload = function(){
    //     adjacency_matrix = reader.result;
    //     console.log("read in= ", adjacency_matrix);
    //     var graphJson =  getGraphData(adjacency_matrix, 0.008, false);
    //     // console.log(graphJson);
    //     displaygraph(graphJson);
    //   }
    //   reader.readAsText(fileopen.files[0])
    // }, false);

    function updateSelectedList(selectedNodes){
      var node_list = "Selected nodes: <br />";
      for (var n of selectedNodes.values()){
        console.log(String(n.id));
        let val = String(n.id)+ "<br />"; //+ "<br />"
        node_list = node_list + val;
      }
      document.getElementById("left").innerHTML = node_list;
    }

    function saveNet(){
      // TODO if null
      let data = JSON.stringify(adjacency_matrix);
      // fs.writeFileSync('net.json', data);
      function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
      }
      console.log(data);
      download(data, 'json.txt', 'text/plain');
      // var csvfile = new Blob(data);
      // console.log(csvfile);
      // downloadBlob(csvfile, 'network.json');

    }

    function getGraphData(adjacency, linkthreshold, json = true){
      // console.log(adjacency)
      if (json ==  true){
        var adj = JSON.parse(JSON.parse(adjacency));
      }else{
        var adj =JSON.parse(adjacency);
      }
      console.log(adj)
      adjacency_matrix = adj;

      // console.log(adj);
      // console.log(typeof adj);
      // const adjacency = adjacency
      nodes = [];
      edges = [];
      adj.forEach(function (row, i) {
        // console.log(i)
        nodes.push({"id": i});
        row.forEach(function (link, j) {
          // console.log(i, j)
          if (link > linkthreshold){
            edges.push({
              "source": i,
              "target" : j,
              "val" : link,
            });
          }
        });
        i ++;
      });
      console.log(nodes);
      console.log(edges);
      return {"nodes": nodes, "links": edges};
    }

    function getnet(params = "") {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("recieved network!");
          var graphdata = getGraphData(this.responseText, 0.008);
          console.log("json==", graphdata);
          // console.log(graphdata.nodes)
          displaygraph(graphdata);
        }
      };
      var url = "http://127.0.0.1:5000" + params
      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("Access-Control-Allow-Origin", "*");
      xhttp.send();
    }

    // var net = getnet();
    function displaygraph(graphData){
      const selectedNodes = new Set();
      updateSelectedList(selectedNodes);
       // const highlightLinks = new Set();
      let hoverNode = null;
      var graphElem = document.getElementById('3d-graph');
      var graphHeight = graphElem.getBoundingClientRect().height;
      var graphWidth = graphElem.getBoundingClientRect().width;
      console.log(graphHeight)
      const graph = ForceGraph3D() // should be const
        (graphElem)
          // .nodeColor(node => 'rgb(255,0,111,1)')
          // pink = 'rgb(255,0,255,0.7)'
          // orange = 'rgba(219,131,16,0.7)'
          // blue = 'rgb(0,0,170,0.7)'
          // red = 'rgb(255,51,51,0.7)'
          // left selected and right normal
          .height('600') //String(graphHeight))
          .width('900')  //String(graphWidth))
          .nodeColor(node =>selectedNodes.has(node) ? 'rgb(255,10,10,0.8)': 'rgb(0,0,170,0.7)')
          // .nodeOpacity(1)
          .nodeLabel(d => `<span style="font-size: 170%; color: #01653A; font-weight: bold;">${d.id}</span>`)
          // .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
          // .nodeThreeObject(node => {
          //   const sprite = new SpriteText(node.id);
          //   sprite.material.depthWrite = false; // make sprite background transparent
          //   sprite.color = node.color;
          //   sprite.textHeight = 8;
          //   return sprite;
          // })
          .enableNodeDrag(false)
          // purple 'rgba(124,21,65,1)'
          .linkColor(link => 'rgba(30,30,30,0.3)')
          // link width is very slow
          // .linkWidth(0.5)
          .linkOpacity(1)
          // .width(1200)
          // .height(800)
          .onNodeClick((node, event) => {
              if (event.ctrlKey || event.shiftKey || event.altKey) { // multi-selection
                selectedNodes.has(node) ? selectedNodes.delete(node) : selectedNodes.add(node);
              } else { // single-selection
                const untoggle = selectedNodes.has(node) && selectedNodes.size === 1;
                selectedNodes.clear();
                !untoggle && selectedNodes.add(node);
              }
              graph.nodeColor(graph.nodeColor()); // update color of selected nodes
              updateSelectedList(selectedNodes);
          })
          .graphData(graphData);
      graph.renderer().setClearColor( 0x000000, 0 );
      graph.backgroundColor('#FFFFFF');

      function updateHighlight() {
        // trigger update of highlighted objects in scene
        graph
          .nodeColor(graph.nodeColor())
          // .linkWidth(Graph.linkWidth())
          // .linkDirectionalParticles(Graph.linkDirectionalParticles());
      }
      function resetView() {
        graph.zoomToFit(400)
        // graph.onEngineStop(() => );
      }
      var button = document.getElementById("btn_reset");
      button.onclick = function(){resetView()};

      var element = document.getElementById('3d-graph')

    }

  </script>
</body>
</html>
